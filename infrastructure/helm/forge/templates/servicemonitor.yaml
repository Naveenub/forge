{{- if and .Values.monitoring.enabled .Values.monitoring.prometheusEnabled }}
# ── ServiceMonitor — tells Prometheus Operator how to scrape Forge ─────────────
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "forge.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "forge.labels" . | nindent 4 }}
    # Must match your Prometheus Operator's serviceMonitorSelector
    release: prometheus
spec:
  selector:
    matchLabels:
      {{- include "forge.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: backend
  endpoints:
    - port: http
      path: /metrics
      interval: {{ .Values.monitoring.scrapeInterval | default "15s" }}
      scrapeTimeout: {{ .Values.monitoring.scrapeTimeout | default "10s" }}
      scheme: http
      # Drop high-cardinality labels to keep metric count manageable
      metricRelabelings:
        - sourceLabels: [__name__]
          regex: "go_.*"
          action: drop
        - sourceLabels: [le]
          targetLabel: le
          action: keep
  namespaceSelector:
    matchNames:
      - {{ .Release.Namespace }}
---
# ── PrometheusRule — alerting rules ───────────────────────────────────────────
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "forge.fullname" . }}-alerts
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "forge.labels" . | nindent 4 }}
    release: prometheus
spec:
  groups:
    - name: forge.backend
      interval: 30s
      rules:
        # ── SLO: P99 latency ≤ 500ms ──────────────────────────────────────────
        - alert: ForgeHighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(http_request_duration_seconds_bucket{job="{{ include "forge.fullname" . }}-backend"}[5m]))
              by (le, route)
            ) > 0.5
          for: 5m
          labels:
            severity: warning
            team: platform
          annotations:
            summary: "Forge P99 latency > 500ms on {{ "{{" }} $labels.route {{ "}}" }}"
            description: "P99 latency is {{ "{{" }} $value | humanizeDuration {{ "}}" }} on route {{ "{{" }} $labels.route {{ "}}" }}."
            runbook_url: "https://github.com/forge/forge/blob/main/docs/RUNBOOK.md#high-latency"

        # ── SLO: Error rate < 1% ───────────────────────────────────────────────
        - alert: ForgeHighErrorRate
          expr: |
            sum(rate(http_requests_total{job="{{ include "forge.fullname" . }}-backend", status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="{{ include "forge.fullname" . }}-backend"}[5m]))
            > 0.01
          for: 3m
          labels:
            severity: critical
            team: platform
          annotations:
            summary: "Forge error rate > 1%"
            description: "Error rate is {{ "{{" }} $value | humanizePercentage {{ "}}" }}."
            runbook_url: "https://github.com/forge/forge/blob/main/docs/RUNBOOK.md#error-rate"

        # ── Pipeline stuck detection ───────────────────────────────────────────
        - alert: ForgePipelineStuck
          expr: |
            forge_pipeline_running_total > 0
            and
            increase(forge_pipeline_completed_total[30m]) == 0
          for: 30m
          labels:
            severity: warning
            team: platform
          annotations:
            summary: "Forge pipelines appear stuck"
            description: "No pipelines have completed in the last 30 minutes while {{ "{{" }} $value {{ "}}" }} are running."
            runbook_url: "https://github.com/forge/forge/blob/main/docs/RUNBOOK.md#stuck-pipelines"

        # ── Pod restart loop ───────────────────────────────────────────────────
        - alert: ForgePodCrashLooping
          expr: |
            increase(kube_pod_container_status_restarts_total{
              namespace="{{ .Release.Namespace }}",
              pod=~"{{ include "forge.fullname" . }}-.*"
            }[15m]) > 3
          for: 5m
          labels:
            severity: critical
            team: platform
          annotations:
            summary: "Forge pod {{ "{{" }} $labels.pod {{ "}}" }} is crash-looping"
            description: "Pod has restarted {{ "{{" }} $value {{ "}}" }} times in 15 minutes."
{{- end }}
